main:
  params: [args]
  steps:
    - init:
        assign:
          - days: ${default(map.get(args, "days"), 7)}
          - lookback_days: ${default(map.get(args, "lookback_days"), 90)}
          - project_key: ${default(map.get(args, "project_key"), "PC")}

          - jira_url: "https://ingest-jira-147201244534.europe-west1.run.app"
          - jira_changelog_url: "https://ingest-jira-changelog-147201244534.europe-west1.run.app"
          - testrail_url: "https://ingest-testrail-147201244534.europe-west1.run.app"
          - testrail_users_url: "https://ingest-testrail-users-147201244534.europe-west1.run.app"
          - testrail_results_url: "https://ingest-testrail-results-147201244534.europe-west1.run.app"
          - bugsnag_url: "https://ingest-bugsnag-147201244534.europe-west1.run.app"
          - gamebench_url: "https://ingest-gamebench-147201244534.europe-west1.run.app"

          - results:
              jira: null
              jira_changelog: null
              testrail: null
              testrail_users: null
              testrail_results: null
              bugsnag: null
              gamebench_android: null
              gamebench_ios: null

          - errors: []
          - status: "ok"

          # ingest-jira REQUIERE project_keys (lista)
          - payload_jira:
              project_keys: ${[project_key]}
              lookback_days: ${lookback_days}

          # ingest-jira-changelog acepta project_key
          - payload_changelog:
              project_key: ${project_key}
              lookback_days: ${lookback_days}

          # test runs / results suelen ser incremental y pueden ignorar body,
          # pero dejamos days para limitar si el servicio lo usa
          - payload_testrail:
              days: ${days}

          - payload_testrail_results:
              days: ${days}

          - payload_bugsnag:
              days: ${days}

          - payload_gamebench_android:
              days: ${days}
              platform: "android"

          - payload_gamebench_ios:
              days: ${days}
              platform: "ios"

    # --------------------------
    # JIRA ISSUES
    # --------------------------
    - jira_try:
        try:
          steps:
            - jira_call:
                call: http.post
                args:
                  url: ${jira_url}
                  timeout: 1800
                  auth:
                    type: OIDC
                    audience: ${jira_url}
                  body: ${payload_jira}
                result: jira_resp
            - jira_store:
                assign:
                  - results.jira: ${jira_resp.body}
        except:
          as: e
          steps:
            - jira_err:
                assign:
                  - errors: ${list.concat(errors, ["jira - " + text.decode(json.encode(e))])}

    # --------------------------
    # JIRA CHANGELOG
    # --------------------------
    - jira_changelog_try:
        try:
          steps:
            - jira_changelog_call:
                call: http.post
                args:
                  url: ${jira_changelog_url}
                  timeout: 1800
                  auth:
                    type: OIDC
                    audience: ${jira_changelog_url}
                  body: ${payload_changelog}
                result: jcl_resp
            - jira_changelog_store:
                assign:
                  - results.jira_changelog: ${jcl_resp.body}
        except:
          as: e
          steps:
            - jcl_err:
                assign:
                  - errors: ${list.concat(errors, ["jira_changelog - " + text.decode(json.encode(e))])}

    # --------------------------
    # TESTRAIL RUNS
    # --------------------------
    - testrail_try:
        try:
          steps:
            - testrail_call:
                call: http.post
                args:
                  url: ${testrail_url}
                  timeout: 1800
                  auth:
                    type: OIDC
                    audience: ${testrail_url}
                  body: ${payload_testrail}
                result: tr_resp
            - testrail_store:
                assign:
                  - results.testrail: ${tr_resp.body}
        except:
          as: e
          steps:
            - tr_err:
                assign:
                  - errors: ${list.concat(errors, ["testrail - " + text.decode(json.encode(e))])}

    # --------------------------
    # TESTRAIL USERS
    # --------------------------
    - testrail_users_try:
        try:
          steps:
            - testrail_users_call:
                call: http.post
                args:
                  url: ${testrail_users_url}
                  timeout: 1800
                  auth:
                    type: OIDC
                    audience: ${testrail_users_url}
                  body: {}
                result: tru_resp
            - testrail_users_store:
                assign:
                  - results.testrail_users: ${tru_resp.body}
        except:
          as: e
          steps:
            - tru_err:
                assign:
                  - errors: ${list.concat(errors, ["testrail_users - " + text.decode(json.encode(e))])}

    # --------------------------
    # TESTRAIL RESULTS
    # --------------------------
    - testrail_results_try:
        try:
          steps:
            - testrail_results_call:
                call: http.post
                args:
                  url: ${testrail_results_url}
                  timeout: 1800
                  auth:
                    type: OIDC
                    audience: ${testrail_results_url}
                  body: ${payload_testrail_results}
                result: trr_resp
            - testrail_results_store:
                assign:
                  - results.testrail_results: ${trr_resp.body}
        except:
          as: e
          steps:
            - trr_err:
                assign:
                  - errors: ${list.concat(errors, ["testrail_results - " + text.decode(json.encode(e))])}

    # --------------------------
    # BUGSNAG
    # --------------------------
    - bugsnag_try:
        try:
          steps:
            - bugsnag_call:
                call: http.post
                args:
                  url: ${bugsnag_url}
                  timeout: 1800
                  auth:
                    type: OIDC
                    audience: ${bugsnag_url}
                  body: ${payload_bugsnag}
                result: bs_resp
            - bugsnag_store:
                assign:
                  - results.bugsnag: ${bs_resp.body}
        except:
          as: e
          steps:
            - bs_err:
                assign:
                  - errors: ${list.concat(errors, ["bugsnag - " + text.decode(json.encode(e))])}

    # --------------------------
    # GAMEBENCH (Android)
    # --------------------------
    - gamebench_android_try:
        try:
          steps:
            - gb_android_call:
                call: http.post
                args:
                  url: ${gamebench_url}
                  timeout: 1800
                  auth:
                    type: OIDC
                    audience: ${gamebench_url}
                  body: ${payload_gamebench_android}
                result: gb_a_resp
            - gb_android_store:
                assign:
                  - results.gamebench_android: ${gb_a_resp.body}
        except:
          as: e
          steps:
            - gb_android_err:
                assign:
                  - errors: ${list.concat(errors, ["gamebench_android - " + text.decode(json.encode(e))])}

    # --------------------------
    # GAMEBENCH (iOS)
    # --------------------------
    - gamebench_ios_try:
        try:
          steps:
            - gb_ios_call:
                call: http.post
                args:
                  url: ${gamebench_url}
                  timeout: 1800
                  auth:
                    type: OIDC
                    audience: ${gamebench_url}
                  body: ${payload_gamebench_ios}
                result: gb_i_resp
            - gb_ios_store:
                assign:
                  - results.gamebench_ios: ${gb_i_resp.body}
        except:
          as: e
          steps:
            - gb_ios_err:
                assign:
                  - errors: ${list.concat(errors, ["gamebench_ios - " + text.decode(json.encode(e))])}

    # --------------------------
    # FINAL STATUS
    # --------------------------
    - set_status_partial_if_errors:
        switch:
          - condition: ${len(errors) > 0}
            assign:
              - status: "partial"

    - finish:
        return:
          status: ${status}
          results: ${results}
          errors: ${errors}