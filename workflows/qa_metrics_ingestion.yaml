panda_ingestion_orchestrator

main:
  params: [args]
  steps:
    - init:
        assign:
          - jira_url: "https://ingest-jira-147201244534.europe-west1.run.app"
          - jira_changelog_url: "https://ingest-jira-changelog-147201244534.europe-west1.run.app"
          - testrail_url: "https://ingest-testrail-147201244534.europe-west1.run.app"
          - testrail_results_url: "https://ingest-testrail-results-147201244534.europe-west1.run.app"
          - bugsnag_url: "https://ingest-bugsnag-147201244534.europe-west1.run.app"
          - payload: {}   # POST body
          - results:
              jira: null
              jira_changelog: null
              testrail: null
              testrail_results: null
              bugsnag: null
          - errors: []
          - status: "ok"

    # --------------------------
    # JIRA ISSUES
    # --------------------------
    - jira_try:
        try:
          steps:
            - jira_call:
                call: http.post
                args:
                  url: ${jira_url}
                  timeout: 900
                  auth:
                    type: OIDC
                    audience: ${jira_url}
                  body: ${payload}
                result: jira_resp
            - jira_store:
                assign:
                  - results.jira: ${jira_resp.body}
        except:
          as: e
          steps:
            - jira_err:
                assign:
                  - errors: ${list.concat(errors, ["jira - " + text.decode(json.encode(e))])}

    # --------------------------
    # JIRA CHANGELOG
    # --------------------------
    - jira_changelog_try:
        try:
          steps:
            - jira_changelog_call:
                call: http.post
                args:
                  url: ${jira_changelog_url}
                  timeout: 1800
                  auth:
                    type: OIDC
                    audience: ${jira_changelog_url}
                  body: ${payload}
                result: jcl_resp
            - jira_changelog_store:
                assign:
                  - results.jira_changelog: ${jcl_resp.body}
        except:
          as: e
          steps:
            - jcl_err:
                assign:
                  - errors: ${list.concat(errors, ["jira_changelog - " + text.decode(json.encode(e))])}

    # --------------------------
    # TESTRAIL RUNS
    # --------------------------
    - testrail_try:
        try:
          steps:
            - testrail_call:
                call: http.post
                args:
                  url: ${testrail_url}
                  timeout: 900
                  auth:
                    type: OIDC
                    audience: ${testrail_url}
                  body: ${payload}
                result: tr_resp
            - testrail_store:
                assign:
                  - results.testrail: ${tr_resp.body}
        except:
          as: e
          steps:
            - tr_err:
                assign:
                  - errors: ${list.concat(errors, ["testrail - " + text.decode(json.encode(e))])}

    # --------------------------
    # TESTRAIL RESULTS
    # --------------------------
    - testrail_results_try:
        try:
          steps:
            - testrail_results_call:
                call: http.post
                args:
                  url: ${testrail_results_url}
                  timeout: 1800
                  auth:
                    type: OIDC
                    audience: ${testrail_results_url}
                  body: ${payload}
                result: trr_resp
            - testrail_results_store:
                assign:
                  - results.testrail_results: ${trr_resp.body}
        except:
          as: e
          steps:
            - trr_err:
                assign:
                  - errors: ${list.concat(errors, ["testrail_results - " + text.decode(json.encode(e))])}

    # --------------------------
    # BUGSNAG
    # --------------------------
    - bugsnag_try:
        try:
          steps:
            - bugsnag_call:
                call: http.post
                args:
                  url: ${bugsnag_url}
                  timeout: 1800
                  auth:
                    type: OIDC
                    audience: ${bugsnag_url}
                  body: ${payload}
                result: bs_resp
            - bugsnag_store:
                assign:
                  - results.bugsnag: ${bs_resp.body}
        except:
          as: e
          steps:
            - bs_err:
                assign:
                  - errors: ${list.concat(errors, ["bugsnag - " + text.decode(json.encode(e))])}

    # --------------------------
    # FINAL STATUS
    # --------------------------
    - set_status_partial_if_errors:
        switch:
          - condition: ${len(errors) > 0}
            assign:
              - status: "partial"

    - finish:
        return:
          status: ${status}
          results: ${results}
          errors: ${errors}
